let follow,UserFollow;_197‍.x([["following",()=>following],["remove",()=>remove],["followinglist",()=>followinglist],["followerlist",()=>followerlist]]);_197‍.w(".",[["default",["follow"],function(v){follow=v}]]);_197‍.w("../../models/userFollow",[["default",["UserFollow"],function(v){UserFollow=v}]]);


// 팔로우
       const following = async (ctx) => {
    try{
        const {followingid} = ctx.request.body;

        const following = new (_197‍.a("UserFollow",UserFollow))({
            userid : ctx.state.user,
            followingid
        });

        await following.save();
        ctx.body = following;  // 이거 안해주면 postman 에서 Not Found 뜸;
    }catch(e){
        throw(500,e);
    }
};_197‍.j(["following"]);

// 팔로우취소
       const remove = async (ctx) => {
    const { id } = ctx.params;
    try{
        await _197‍.a("UserFollow",UserFollow).findByIdAndDelete(id).exec();
        ctx.status = 204;
    }catch(e){
        ctx.throw(500,e);
    }
};_197‍.j(["remove"]);

//팔로우 리스트
// GET /api/follow/followinglist?username=
       const followinglist = async (ctx) => {
    const { username } = ctx.query;
    const query = {   // 아 만약 follower리스트 뽑아올려면 반대로 followingid.followingid 하면 될듯? url에다가 followingid= 이렇게 하고
        ...(username ? {'userid.username' : username} : {}),
    };

    try{
        const following = await _197‍.a("UserFollow",UserFollow).find(query)
        .sort({_id:-1})
        .limit(5)
        .lean()
        .exec();
        const followingCount = await _197‍.a("UserFollow",UserFollow).countDocuments(query).exec;
        ctx.set('Last-Page',Math.ceil(followingCount/5));
        ctx.body = following.map((follow) => ({
            ...follow,
            body:follow.body,
        }));
    }catch(e){
        ctx.throw(500,e);
    }
};;_197‍.j(["followinglist"]);

//팔로워 리스트
// GET /api/follow/followerlist?followingid=lemon
       const followerlist = async (ctx) => {
    const { followingid } = ctx.query;
    const query = {
        ...(followingid ? {'followingid.followingid' : followingid} : {}),
    };

    try{
        const follower = await _197‍.a("UserFollow",UserFollow).find(query)
        .sort({_id:-1})
        .limit(5)
        .lean()
        .exec();
        const followerCount = await _197‍.a("UserFollow",UserFollow).countDocuments(query).exec;
        ctx.set('Last-Page',Math.ceil(followerCount/5));
        ctx.body = follower.map((follower) => ({
            ...follower,
            body:follower.body,
        }));
    }catch(e){
        ctx.throw(500,e);
    }
};_197‍.j(["followerlist"]);


